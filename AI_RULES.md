# ü§ñ Orderly Conversations - AI Agent Handover Protocol

**IMPORTANT:** This file defines the personality, rules, and technical constraints for any AI Agent working on this codebase. YOU MUST FOLLOW THESE INSTRUCTIONS STRICTLY.

## 1. üó£Ô∏è Communication Protocol (User Language)
- **LANGUAGE:** **BENGALI (Bangla) ONLY**.
- **User Instruction:** "sob somoi banglai bolba english buji na ami" (Always speak Bengali, I don't understand English).
- **Tone:** Helpful, respectful, and simple. Avoid complex technical jargon. Explain things like you are talking to a non-tech trader.
- **Example:** Instead of saying "I fixed the asynchronous race condition in the API", say "‡¶≠‡¶æ‡¶á, ‡¶Ü‡¶Æ‡¶ø API ‡¶è‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶ø‡¶Ç ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡¶ø, ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡¶ø‡¶∏ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§"

## 2. üß† Core Technical Constraints (DO NOT IGNORE)
- **AI Model Standard:**
  - **DEFAULT:** `gemini-2.5-flash` (Use exact ID).
  - **SECONDARY:** `gemini-2.5-flash-lite` (Use exact ID).
  - **PROHIBITED:** Do NOT use Gemini 1.0, 1.5, or 2.0.
- **Timeout Rules:**
  - Text Generation: **15s** (Fail Fast & Retry).
  - Vision/Axios Calls: **20s**.
- **API Keys:**
  - User `own_api` must be respected. If provided, use their key + their selected model. NO FALLBACKS for Own API.

## 3. üõ°Ô∏è Critical Business Logic (The "Brain")
### A. WhatsApp Logic (WAHA)
1.  **LID Safety:** Never send messages to `@lid` (Linked Device) IDs. Always convert/use `@c.us` for users. Messages *from* `@lid` must be saved with `reply_by: 'admin'` to prevent Bot Loops.
2.  **Emoji Lock System (Messenger Parity):**
    - Bot must respect `page_prompts` (block_emoji, unblock_emoji) AND `pageConfig` settings.
    - If Admin sends üîí (or configured emoji), Bot MUST stop replying (Handover).
    - Logic checks last 50 messages for Admin emojis.
    - **Implementation Location:** `whatsappController.js` (lines ~1131).
3.  **User Name Extraction:**
    - Always try to fetch `pushName` from WAHA payload.
    - If not found, check `whatsapp_contacts`.
    - **Critical:** NEVER overwrite a valid name with 'Unknown' in the database (`dbService.js` logic).
    - **AI Context:** Pass explicit `senderName` to `aiService.generateResponse()`.

### B. Messenger Logic (Graph API)
1.  **Regression Testing:** Any change to WhatsApp MUST NOT break Messenger. They share `aiService.js` but have different Controllers.
2.  **Emoji Logic:** Uses `webhookController.js`.
3.  **Strict Separation:** Do not mix `whatsapp_` tables with `fb_` tables unless using shared `user_configs`.

### C. Order Tracking
1.  **Duplicate Check:** Check last 24h for similar orders to prevent duplicates.
2.  **Status:** Bot can read `whatsapp_order_tracking` and `fb_order_tracking` to give status updates.
3.  **Image Sending:** Use JSON format (`[{ type: 'image_url', image_url: { url: ... } }]`) for passing image URLs to AI, not plain text.

## 4. üìÇ Project Structure & Rules
- **Backend:** Node.js (Express).
- **Frontend:** React + Vite + Tailwind.
- **Database:** Supabase.
- **Git:** Use semicolons (`;`) for chaining commands (PowerShell compatible).
- **New Files:** NEVER create new files unless absolutely necessary. Modify existing ones.

## 5. üöÄ Known "Pain Points" & Fixes
- **WhatsApp QR Logic (CRITICAL):**
  - **Polling:** Frontend (`IntegrationPage.tsx`) MUST poll `/session/qr/:sessionName` every 3s.
  - **Reason:** Session creation endpoint times out (20s), but backend continues working. Polling ensures the user gets the valid QR code eventually.
  - **Download:** QR codes are base64 strings. Download logic is implemented in frontend.
  - **Status:** Watch out for `created` vs `WORKING`. `created` needs polling.
- **Frontend Imports:**
  - **Conflict:** `import { Image } from "lucide-react"` conflicts with the browser's native `new Image()` constructor.
  - **Fix:** If you need the native Image, rename the icon import (e.g., `import { Image as ImageIcon } ...`).
- **Image Sending:** Use JSON format for passing image URLs to AI.
- **PowerShell:** Always use `;` instead of `&&` in terminal commands.
- **Restart:** If backend logic changes, restart the node server (`npm run dev` in backend).
- **Bot Loops:** Always check `recentBotReplies` and `LID` status before sending.

---
*Generated by Orderly Bot (Gemini 3.0) for seamless handover.*